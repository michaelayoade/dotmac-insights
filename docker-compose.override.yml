# Development overrides - automatically loaded by docker-compose
# This file enables hot-reload and mounts source code for development
#
# Usage:
#   docker-compose up              # Uses both files (dev mode)
#   docker-compose -f docker-compose.yml up  # Production mode only

services:
  api:
    # Override command to use uvicorn with --reload for development
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    environment:
      PYTHONDONTWRITEBYTECODE: "1"
    # Mount source code for hot-reload
    volumes:
      - ./app:/app/app:ro
      - ./.env:/app/.env:ro

  celery_worker:
    # Increase concurrency from 4 to 8 for faster queue processing
    command: celery -A app.worker worker --loglevel=info -c 8
    environment:
      PYTHONDONTWRITEBYTECODE: "1"
    # Mount source code
    volumes:
      - ./app:/app/app:ro
      - ./.env:/app/.env:ro
    # Override healthcheck in dev (no-op)
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 5s
      retries: 1

  celery_beat:
    environment:
      PYTHONDONTWRITEBYTECODE: "1"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: "http://149.102.135.97:8000"
      INTERNAL_API_URL: "http://api:8000"
      NEXT_PUBLIC_SERVICE_TOKEN: "5tYE5IkM11HHhQh3C3ql2blUTn2w4QhSc5BO5mYtuiLtLwLQD3Y"
      NEXT_PUBLIC_DEV_TOKEN: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkZXYtdXNlci0xIiwiZW1haWwiOiJkZXZAZG90bWFjLmlvIiwic2NvcGVzIjpbImN1c3RvbWVyczpyZWFkIiwiY3VzdG9tZXJzOndyaXRlIiwiYW5hbHl0aWNzOnJlYWQiLCJzeW5jOnJlYWQiLCJzeW5jOndyaXRlIiwiZXhwbG9yZTpyZWFkIiwiYWRtaW46cmVhZCIsImFkbWluOndyaXRlIiwiaHI6cmVhZCIsImhyOndyaXRlIiwiYWNjb3VudGluZzpyZWFkIiwiYWNjb3VudGluZzp3cml0ZSIsInBheW1lbnRzOnJlYWQiLCJwYXltZW50czp3cml0ZSIsIm9wZW5iYW5raW5nOnJlYWQiLCJvcGVuYmFua2luZzp3cml0ZSIsImdhdGV3YXk6cmVhZCIsImdhdGV3YXk6d3JpdGUiXSwiaWF0IjoxNzY2MjI1MTU0LCJleHAiOjE3OTc3NjExNTR9.ghyGRFX1H4xLnqvIdgMjlB88sa9eoL2qqpkI7atU6CA"
    # Mount source code for hot-reload
    volumes:
      - ./frontend/app:/app/app
      - ./frontend/components:/app/components
      - ./frontend/hooks:/app/hooks
      - ./frontend/lib:/app/lib
      - ./frontend/public:/app/public
      - ./frontend/tailwind.config.ts:/app/tailwind.config.ts
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/next.config.js:/app/next.config.js
      - ./frontend/postcss.config.js:/app/postcss.config.js
    # Override healthcheck in dev (no-op)
    healthcheck:
      test: ["CMD", "true"]
      interval: 60s
      timeout: 5s
      retries: 1
